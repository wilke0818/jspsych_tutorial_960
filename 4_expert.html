<!DOCTYPE html>
<html>

<head>
    <title>Expert</title>
    <meta http-equiv="pragma" content="no-cache">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="./jspsych/dist/jspsych.js"></script>
    <link href="./jspsych/dist/jspsych.css" rel="stylesheet" type="text/css" />
    <script src="./jspsych/dist/plugin-preload.js"></script>
    <!-- <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.2"></script> -->
    <!-- <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script> -->
    <script src="./jspsych/dist/plugin-html-button-response.js"></script>
    <!-- <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.2"></script> -->
    <!-- <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.2"></script> -->
    <!-- <script src="https://unpkg.com/@jspsych/plugin-image-button-response@1.1.2"></script> -->
    <!-- <script src="https://unpkg.com/@jspsych/plugin-image-slider-response@1.1.2"></script> -->
    <!-- <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.1.2"></script> -->
    <!-- <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.2"></script> -->
    <!-- <script src="https://unpkg.com/@jspsych/plugin-categorize-html@1.1.2"></script> -->
    <!-- <script src="https://unpkg.com/@jspsych/plugin-categorize-image@1.1.2"></script> -->
    <!-- <script src="https://unpkg.com/@jspsych/plugin-free-sort@1.0.2"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/gh/jspsych/jspsych@jspsych@7.0.0/examples/js/webgazer/webgazer.js"></script> -->
    <script src="./js/webgazer/webgazer.js"></script>
    <script src="./jspsych/dist/extension-webgazer.js"></script>
    <!-- <script src="https://unpkg.com/@jspsych/extension-mouse-tracking@1.0.2"></script> -->
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js'></script>
    <script src="./jspsych/dist/plugin-webgazer-init-camera.js"></script>
    <script src="./jspsych/dist/plugin-webgazer-validate.js"></script>
    <script src="./jspsych/dist/plugin-webgazer-calibrate.js"></script>
    <script src="util.js"></script>
</head>

<body></body>

<script>

    // Initialize the jsPsych object (possibly with arguments: https://www.jspsych.org/7.3/reference/jspsych/)
    var jsPsych = initJsPsych({
        on_finish: function () {
            jsPsych.data.displayData();
            // write_data_to_server();
        },
        override_safe_mode: true,
        extensions: [
            {
                type: jsPsychExtensionWebgazer
            }
        ]
    });

    var timeline = [];
    var post_validation_timeline = [];



    var camera_instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <p>In order to participate you must allow the experiment to use your camera.</p>
          <p>You will be prompted to do this on the next screen.</p>
          <p>If you do not wish to allow use of your camera, you cannot participate in this experiment.<p>
          <p>It may take up to 30 seconds for the camera to initialize after you give permission.</p>
        `,
        choices: ['Got it'],
    }

    timeline.push(camera_instructions)

    var init_camera_trial = {
        type: jsPsychWebgazerInitCamera
    }

    timeline.push(init_camera_trial)

    var calibration_instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <p>Now you'll calibrate the eye tracking, so that the software can use the image of your eyes to predict where you are looking.</p>
          <p>You'll see a series of dots appear on the screen. Look at each dot and click on it.</p>
        `,
        choices: ['Got it'],
    }

    timeline.push(calibration_instructions)

    var calibration_trial = {
        type: jsPsychWebgazerCalibrate,
        calibration_points: [[15,15], [50, 15], [85,15],
                             [15,50], [50, 50], [85,50],
                             [15,85], [50, 85], [85,85]],
                             
        calibration_mode: 'click',
        repetitions_per_point: 2
    }

    timeline.push(calibration_trial)

    var validation_instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <p>Now we'll measure the accuracy of the calibration.</p>
          <p>Look at each dot as it appears on the screen.</p>
          <p style="font-weight: bold;">You do not need to click on the dots this time.</p>
        `,
        choices: ['Got it'],
        post_trial_gap: 1000
    }
    timeline.push(validation_instructions)

    var validation = {
        type: jsPsychWebgazerValidate,
        validation_points: [
          [25,25],[75,25],[50,50],[25,75],[75,75]
        ],
        roi_radius: 200,
        time_to_saccade: 1000,
        validation_duration: 2500,
        show_validation_data: true,
        data: {
          task: 'validate'
        }
    }

    timeline.push(validation)

    var recalibrate_instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <p>The accuracy of the calibration is a little lower than we'd like.</p>
          <p>Let's try calibrating one more time.</p>
          <p>On the next screen, look at the dots and click on them.<p>
        `,
        choices: ['OK'],
    }

    var recalibrate = {
        timeline: [recalibrate_instructions, calibration_trial, validation_instructions, validation],
        conditional_function: function(){
          var validation_datas = jsPsych.data.get().filter({task: 'validate'}).values();
          var validation_data = validation_datas[validation_datas.length-1]
          console.log(jsPsych.data.get().filter({task: 'validate'}).values());
          console.log(validation_data);
          return validation_data.percent_in_roi.some(function(x){
            var minimum_percent_acceptable = 40;
            return x < minimum_percent_acceptable;
          });
        },
        data: {
          phase: 'recalibration'
        }
    }

    timeline.push(recalibrate)
    timeline.push(recalibrate)

    

    

    var calibration_done = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <p>Great, we're done with calibration!</p>
        `,
        choices: ['OK']
    }

    var failed_validation = {
      type: jsPsychHtmlButtonResponse, // This trial will use the "html-button-response" plugin
      stimulus: [
            '<h2>Unfortunately we couldn\'t get our gaze detection working well enough to run the experiment</h2>' +
            '<p>Feel free to retry the experiment in a place with possibly better lighting.</p>' +
            '<p>We appreciate your efforts! Thanks for trying!</p>'
      ],
      choices: ['End experiment'],
      on_finish: function(data){
        jsPsych.endExperiment();
      }
    };

    var final_check = {
        timeline: [failed_validation],
        conditional_function: function(){
          var validation_datas = jsPsych.data.get().filter({task: 'validate'}).values();
          var validation_data = validation_datas[validation_datas.length-1]
          console.log(jsPsych.data.get().filter({task: 'validate'}).values());
          console.log(validation_data);
          return validation_data.percent_in_roi.some(function(x){
            var minimum_percent_acceptable = 40;
            return x < minimum_percent_acceptable;
          });
        },
        data: {
          phase: 'recalibration'
        }
    }

    timeline.push(final_check);

    timeline.push(calibration_done)

    
    

    // The `write_data_to_server` function requires two global variables to be defined:
    // `url_write_data_php` (web location of the write_data.php script) and `output_filename`
    // var url_experiment_dir = 'https://msaddler.scripts.mit.edu/jspsych_tutorial_960/';
    // var url_write_data_php = url_experiment_dir + 'write_data.php';
    // var subject_id = jsPsych.data.getURLVariable('subject_id');
    // console.log(`subject_id from URL: ${subject_id}`);
    // if (!subject_id) {
    //     subject_id = jsPsych.randomization.randomID(10);
    //     console.log(`subject_id randomly assigned: ${subject_id}`);
    // }
    // // var subject_id = jsPsych.data.getURLVariable('PROLIFIC_PID'); // capture info from Prolific
    // // var session_id = jsPsych.data.getURLVariable('SESSION_ID'); // capture info from Prolific
    // // var study_id = jsPsych.data.getURLVariable('STUDY_ID'); // capture info from Prolific
    // // var completion_url = 'https://app.prolific.co/submissions/complete?cc=AAAAAAAA'; // Get from Prolific
    // var output_filename = `data/experiment4_${subject_id}.json`;
    // console.log(`Data will be saved to: ${url_experiment_dir + output_filename}`);

    // // Initialize a timeline (just an empty array)
    // var timeline = [];

    // // A preload object will ensure images are loaded from the server before the trial they are used
    // var preload = {
    //     type: jsPsychPreload,
    //     auto_preload: true,
    // };
    // timeline.push(preload);

    // // Always good to put experiment instructions /  disclaimers on the first page
    // var first_page = {
    //     type: jsPsychHtmlButtonResponse, // This trial will use the "html-button-response" plugin
    //     stimulus: [
    //         '<h2>Demo of fancier plugins</h2>' +
    //         '<p><b>These plugins may not work with all browswers / devices.</b></p>' +
    //         '<p>In this experiment, ...</p>' +
    //         '<p>Your task is to...</p>'
    //     ],
    //     choices: ['Begin experiment'],
    // };
    // timeline.push(first_page);

    // // Mouse-tracking draw trial
    // var trial_draw = {
    //     type: jsPsychHtmlButtonResponse,
    //     stimulus: '<div id="target" style="width:450px; height: 450px; background-color: #666; margin: auto;"></div>',
    //     choices: ['Done'],
    //     prompt: "<p>Move your mouse around inside the square.</p>",
    //     extensions: [
    //         { type: jsPsychExtensionMouseTracking, params: { targets: ['#target'] } }
    //     ],
    //     data: {
    //         task: 'draw'
    //     }
    // };
    // timeline.push(trial_draw);

    // // Mouse-tracking replay trial
    // var trial_replay = {
    //     type: jsPsychHtmlButtonResponse,
    //     stimulus: '<div id="target" style="width:450px; height: 450px; background-color: #666; margin: auto; position: relative;"></div>',
    //     choices: ['Done'],
    //     prompt: "<p>Here's the recording of your mouse movements</p>",
    //     on_load: function () {
    //         var mouseMovements = jsPsych.data.get().last(1).values()[0].mouse_tracking_data;
    //         var targetRect = jsPsych.data.get().last(1).values()[0].mouse_tracking_targets['#target'];
    //         var startTime = performance.now();
    //         function draw_frame() {
    //             var timeElapsed = performance.now() - startTime;
    //             var points = mouseMovements.filter((x) => x.t <= timeElapsed);
    //             var html = ``;
    //             for (var p of points) {
    //                 html += `<div style="width: 3px; height: 3px; background-color: blue; position: absolute; top: ${p.y - 1 - targetRect.top}px; left: ${p.x - 1 - targetRect.left}px;"></div>`
    //             }
    //             document.querySelector('#target').innerHTML = html;
    //             if (points.length < mouseMovements.length) {
    //                 requestAnimationFrame(draw_frame);
    //             }
    //         }
    //         requestAnimationFrame(draw_frame);
    //     },
    //     data: {
    //         task: 'replay'
    //     }
    // }
    // timeline.push(trial_replay);

    // // Image sorting trial (NOTE: this seems to work for Chrome but not Safari)
    // stimuli_to_sort = [];
    // list_image_num = jsPsych.randomization.repeat(arange(40, 60, 1), 1);
    // for (var itr = 0; itr < 6; itr += 1) {
    //     stimuli_to_sort.push(`images/condition0/${list_image_num[itr]}.png`)
    // }
    // console.log(stimuli_to_sort);
    // var trial_sort = {
    //     type: jsPsychFreeSort,
    //     stimuli: stimuli_to_sort,
    //     stim_width: 100,
    //     stim_height: 100,
    //     sort_area_shape: 'square',
    //     sort_area_width: 500,
    //     sort_area_height: 500,
    //     prompt: "<p>Click and drag the images below to sort them so that similar images are close together.</p>",
    //     prompt_location: 'below',
    // };
    // timeline.push(trial_sort);

    // // Run the timeline
    jsPsych.run(timeline);
</script>

</html>